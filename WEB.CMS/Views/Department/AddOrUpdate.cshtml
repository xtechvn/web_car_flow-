@{
    Layout = null;
}
@using Entities.Models
@{
    var _DepartmentList = (List<Department>)ViewBag.DepartmentList;
    var _BranchList = (List<AllCode>)ViewBag.BranchList;
    
    async Task ShowDepartment(Department item, int level = 0)
    {
        var childs = _DepartmentList.Where(s => s.ParentId == item.Id).ToList();
        string str_level = string.Empty;
        for (int i = 0; i < level; i++)
        {
            str_level += "---";
        }

        <option value="@item.Id">@str_level @item.DepartmentName</option>

        @if (childs != null && childs.Any())
        {
            level++;
            foreach (var child in childs)
            {
                await ShowDepartment(child, level);
            }
        }
    }
}
@model Department
<style>
    .form-group label.error {
        color: red;
    }
</style>
<form id="form_department">
    <input type="hidden" asp-for="@Model.Id" name="Id" />
    
    <div class="form-grid">
        <!-- Tên phòng ban -->
        <div class="form-group">
            <label>Tên phòng ban <span>*</span></label>
            <input type="text" asp-for="@Model.DepartmentName" id="DepartmentName" name="DepartmentName" placeholder="Nhập tên phòng ban">
        </div>

        <!-- Mã phòng ban -->
        <div class="form-group">
            <label>Mã phòng ban</label>
            <input type="text" asp-for="@Model.DepartmentCode" id="DepartmentCode" name="DepartmentCode" placeholder="Nhập mã phòng ban">
        </div>

        <!-- Phòng ban cha -->
        <div class="form-group">
            <label>Phòng ban cha</label>
            <select asp-for="@Model.ParentId" id="ParentId" name="ParentId">
                <option value="0">-- Chọn phòng ban cha --</option>
                @if (_DepartmentList != null && _DepartmentList.Any())
                {
                    var parents = _DepartmentList.Where(s => s.ParentId == 0).ToList();
                    foreach (var item in parents)
                    {
                        await ShowDepartment(item);
                    }
                }
            </select>
        </div>

        <!-- Chi nhánh -->
        <div class="form-group">
            <label>Chi nhánh</label>
            <select asp-for="@Model.Branch" id="branch-code" name="Branch">
                <option value="">-- Chọn chi nhánh --</option>
                @if (_BranchList != null && _BranchList.Any())
                {
                    foreach (var item in _BranchList)
                    {
                        <option value="@item.CodeValue">@item.Description</option>
                    }
                }
            </select>
        </div>

        <!-- Thứ tự sắp xếp -->
        <div class="form-group">
            <label>Thứ tự sắp xếp</label>
            <input type="number" asp-for="@Model.Sort" id="Sort" name="Sort" placeholder="Nhập thứ tự sắp xếp" min="0">
        </div>

        <!-- Cho phép báo cáo -->
        <div class="form-group">
            <label>Cho phép báo cáo</label>
            <select asp-for="@Model.IsReport" id="IsReport" name="IsReport">
                <option value="true">Có</option>
                <option value="false">Không</option>
            </select>
        </div>

        <!-- Mô tả -->
        <div class="form-group" style="grid-column: 1 / -1;">
            <label>Mô tả</label>
            <textarea asp-for="@Model.Description" id="Description" name="Description" placeholder="Nhập mô tả phòng ban" rows="3"></textarea>
        </div>
    </div>

    <div class="actions">
        <button type="button" class="cancel" onclick="_department.modal_element.modal('hide')">Hủy</button>
        <button type="button" class="confirm" onclick="_department.OnSave()">@(Model.Id == 0 ? "Thêm mới" : "Cập nhật")</button>
    </div>
</form>

<script>
$(document).ready(function() {
    // Initialize select2 for branch dropdown
    $('#branch-code').select2({
        minimumResultsForSearch: Infinity
    });
    
    // Set default values for new department
    @if (Model.Id == 0)
    {
        <text>
        $('#IsReport').val('true');
        </text>
    }
});
</script>
